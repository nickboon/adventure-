<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Adventure!</title>
		<style>
			body {
				text-align: center;
				padding: 1em;
				font-family: Harrington, Georgia, 'Times New Roman', Times, serif;
			}
			h1,
			section {
				margin-bottom: 1em;
			}
			.panel {
				padding: 1em;
				outline: 1px solid black;
				width: 80%;
				margin: 1em auto;
			}
		</style>
	</head>
	<body>
		<div class="panel">
			<h1 id="currentLocationHeader"></h1>
			<section id="currentStateSection"></section>
			<section id="playerActionsSection"></section>
		</div>
		<div class="panel">
			<h2>ðŸŽ’</h2>
			<section id="bagSection">No Items</section>
		</div>
		<script>
			// get a reference to the html elements on the page so the JavaScript can use them.
			const locationHeader = document.getElementById('currentLocationHeader');
			const currentStateSection = document.getElementById(
				'currentStateSection'
			);
			const playerActionsSection = document.getElementById(
				'playerActionsSection'
			);
			const bagSection = document.getElementById('bagSection');

			// define some variables to keep track of the game state
			let startingGameState = '';
			let currentGameState = '';
			let currentLocation = '';

			// fetch the current value of state
			function goTo(state) {
				return () => state;
			}

			function goToCurrentLocation() {
				return currentLocation;
			}

			function goToStartingGameState() {
				return startingGameState;
			}

			function goToCurrentGameState() {
				return currentGameState;
			}

			function createPlayerAction(description, getNextState) {
				return { description, getNextState };
			}

			function createPlaceholder(description) {
				return createPlayerAction(description, goToCurrentGameState);
			}

			function createContinueAction() {
				return createPlayerAction('Continue', goToCurrentLocation);
			}

			function createStartAgainAction() {
				return createPlayerAction('Start again', goToStartingGameState);
			}

			// create page dropdown lists
			function appendOption(selector, text, getValue) {
				const option = document.createElement('option');
				option.text = text;
				option.value = getValue();
				selector.appendChild(option);
			}

			function createDropdownIn(section, placeholder) {
				const dropdown = document.createElement('select');
				appendOption(dropdown, placeholder, goToCurrentGameState);
				dropdown.addEventListener('change', (e) =>
					ChangeGameStateTo(e.target.value)
				);
				section.append(dropdown);

				return dropdown;
			}

			function isBagEmpty() {
				return bagSection.firstChild.nodeType === Node.TEXT_NODE;
			}

			function addToBag(action) {
				let bagSectionDropdown = bagSection.firstChild;
				if (isBagEmpty()) {
					bagSection.innerHTML = '';
					bagSectionDropdown = createDropdownIn(
						bagSection,
						'Select an item to use:'
					);
				}

				appendOption(
					bagSectionDropdown,
					action.description,
					action.getNextState
				);
			}

			function resetBagOptions() {
				if (isBagEmpty()) return;

				var placeholder = bagSection.firstChild.firstChild;
				placeholder.value = currentGameState;
				placeholder.selected = true;
			}

			function buildActionOptions(actions) {
				const playerActionDropdown = createDropdownIn(
					playerActionsSection,
					'Chose an action: '
				);
				actions.forEach((action) =>
					appendOption(
						playerActionDropdown,
						action.description,
						action.getNextState
					)
				);
			}

			// load a new state in response to player's choice
			function ChangeGameStateTo(stateKey) {
				const newGameState = gameStates[stateKey];
				currentGameState = stateKey;

				// set the current location if state is set in a particular location
				if (newGameState.location) {
					locationHeader.innerHTML = newGameState.location;
					currentLocation = stateKey;
				}

				// load state description
				currentStateSection.innerHTML = newGameState.description;

				// load player actions
				playerActionsSection.innerHTML = '';
				buildActionOptions(newGameState.playerActions);

				// run any game actions for the new state
				if (newGameState.gameActions)
					newGameState.gameActions.forEach((gameAction) => gameAction());

				// reset bag
				resetBagOptions();
			}

			// states
			const playerState = {}; // we can add things about the player here

			// These are all the locations and events that happen in the game.
			// Some are locations and so have a location name, which allows the game to kep track of where the player is. If it doesn't have a location name, it's somesort of event that could potentially happen anywhere. Player actions are the options the player is presented with in order to progress in the game. You have to give it a description and the game state it will move on to. Game actions are things the game will do when it moves to that state. This is notsomething the player can choose.
			// Try adding new states to expand the game!

			const gameStates = {
				kitchen: {
					location: 'Kitchen',
					description: 'There is a kettle, a mug and a jar of coffee.',
					playerActions: [
						createPlayerAction('Go south', goTo('bedroom')),
						createPlayerAction('Make coffee', goTo('makeCoffee')),
					],
				},
				makeCoffee: {
					description: 'You have made a nice hot mug of coffee.',
					playerActions: [createContinueAction()],
					gameActions: [
						() =>
							addToBag(
								createPlayerAction('Mug Of Coffee', goTo('drinkCoffee'))
							),
					],
				},
				drinkCoffee: {
					description: 'The Coffee is delicious.',
					playerActions: [createContinueAction()],
					gameActions: [() => (playerState.hasDrunkCoffee = true)],
				},
				bedroom: {
					location: 'Bedroom',
					description: 'There is a bed and a book',
					playerActions: [
						createPlayerAction('Go north', goTo('kitchen')),
						createPlayerAction('Go south', goTo('outside')),
						createPlayerAction('Go to sleep', () =>
							playerState.hasDrunkCoffee ? 'cantSleep' : 'sleeping'
						),
						createPlayerAction('Read book', goTo('readBook')),
					],
				},
				cantSleep: {
					description:
						'The coffee you drank earlier is making it hard to drop off...',
					playerActions: [createContinueAction()],
				},
				sleeping: {
					description: 'zzzzz...',
					playerActions: [createContinueAction()],
				},
				readBook: {
					description: 'The book tells you you must go outside to win.',
					playerActions: [createContinueAction()],
				},
				outside: {
					location: 'Outside',
					description: 'You are outside. YOU WIN!! CONGRATULATIONS!!',
					playerActions: [createStartAgainAction()],
				},
			};

			// initialize up state tracking variables
			startingGameState = 'kitchen';
			// load starting state
			ChangeGameStateTo(startingGameState);
		</script>
	</body>
</html>
